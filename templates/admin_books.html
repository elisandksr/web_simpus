{{define "content"}}
<div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div>
            <h3 style="margin:0">Manajemen Buku</h3>
            <p style="color:var(--text-light)">Kelola koleksi buku perpustakaan.</p>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="openModal('add')"><i class="fas fa-plus"></i> Tambah Buku</button>
        </div>
    </div>

    <input type="text" id="searchInput" placeholder="Cari buku..." onkeyup="loadBooks()"
        style="width: 100%; margin-bottom: 20px;">

    <div style="overflow-x:auto;">
        <table id="booksTable" style="width:100%; border-collapse:separate; border-spacing:0;">
            <thead>
                <tr
                    style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color:white; text-align:left;">
                    <th style="padding:15px; border-top-left-radius:12px;">Cover</th>
                    <th style="padding:15px;">Judul</th>
                    <th style="padding:15px;">Penulis</th>
                    <th style="padding:15px;">Kategori</th>
                    <th style="padding:15px;">Tahun</th>
                    <th style="padding:15px;">Stok</th>
                    <th style="padding:15px; border-top-right-radius:12px;">Aksi</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Book Modal -->
<div id="bookModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Tambah Buku</h3>
        <form onsubmit="saveBook(event)">
            <input type="hidden" id="bookId">
            <div style="margin-bottom:15px;"><label>Judul Buku</label><input id="bTitle" required></div>
            <div style="margin-bottom:15px;"><label>Penulis</label><input id="bAuthor" required></div>
            <div style="margin-bottom:15px;">
                <label>Kategori</label>
                <select id="bCat" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;">
                    <option value="">Pilih Kategori</option>
                </select>
            </div>
            <div style="margin-bottom:15px;"><label>Tahun Terbit</label><input type="number" id="bYear" min="1900"
                    max="2099" required></div>
            <div style="margin-bottom:15px;"><label>Stok</label><input type="number" id="bStock" required></div>
            <!-- Image Upload -->
            <div style="margin-bottom:20px;">
                <label>Foto Buku</label>
                <div id="imgPreview"
                    style="margin-bottom:10px; width:100px; height:140px; background:#f0f0f0; border-radius:5px; display:none; overflow:hidden;">
                </div>
                <input type="file" id="bImgFile" accept="image/*">
            </div>

            <div style="display:flex; justify-content:end; gap:10px;">
                <button type="submit" class="btn btn-primary">Simpan</button>
                <button type="button" class="btn btn-danger" onclick="toggleModal('bookModal', false)">Batal</button>
            </div>
        </form>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
    loadBooks();
    loadCategories();

    async function loadBooks() {
        const q = document.getElementById('searchInput').value;
        const res = await fetch(`/api/books?q=${q}`);
        const books = await res.json();

        document.getElementById('booksTable').querySelector('tbody').innerHTML = books.map(b => `
            <tr>
                <td style="width:60px;">
                    <div style="width:50px; height:70px; background:var(--background); border-radius:6px; overflow:hidden; border:1px solid #E2E8F0;">
                        ${b.image_url ? `<img src="${b.image_url}" style="width:100%; height:100%; object-fit:cover;">` : '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-secondary);"><i class="fas fa-book"></i></div>'}
                    </div>
                </td>
                <td><div style="font-weight:600">${b.title}</div></td>
                <td><div style="color:var(--text-light)">${b.author}</div></td>
                <td><span class="badge bg-success">${b.category}</span></td>
                <td>${b.published_year}</td>
                <td><span style="font-weight:bold">${b.stock}</span></td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick='editBook(${JSON.stringify(b)})'><i class="fas fa-edit"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="delBook(${b.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    // Category Management
    async function loadCategories() {
        const res = await fetch('/api/categories', { headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) {
            const cats = await res.json();
            const select = document.getElementById('bCat');

            // Fix select map if cats is array
            select.innerHTML = '<option value="">Pilih Kategori</option>' +
                cats.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }
    }

    function openModal(mode) {
        document.getElementById('modalTitle').innerText = 'Tambah Buku';
        document.getElementById('bookId').value = '';
        document.getElementById('bTitle').value = '';
        document.getElementById('bAuthor').value = '';
        document.getElementById('bCat').value = ''; // Will select default
        document.getElementById('bYear').value = '';
        document.getElementById('bStock').value = '';
        document.getElementById('bImgFile').value = '';
        document.getElementById('imgPreview').style.display = 'none';
        toggleModal('bookModal', true);
    }

    function editBook(book) {
        document.getElementById('modalTitle').innerText = 'Edit Buku';
        document.getElementById('bookId').value = book.id;
        document.getElementById('bTitle').value = book.title;
        document.getElementById('bAuthor').value = book.author;
        document.getElementById('bAuthor').value = book.author;
        document.getElementById('bCat').value = book.category;
        document.getElementById('bYear').value = book.published_year;
        document.getElementById('bStock').value = book.stock;

        const preview = document.getElementById('imgPreview');
        if (book.image_url) {
            preview.style.display = 'block';
            preview.innerHTML = `<img src="${book.image_url}" style="width:100%; height:100%; object-fit:cover;">`;
        } else {
            preview.style.display = 'none';
        }
        toggleModal('bookModal', true);
    }

    async function saveBook(e) {
        e.preventDefault();
        const id = document.getElementById('bookId').value;
        const title = document.getElementById('bTitle').value;
        const author = document.getElementById('bAuthor').value;
        const category = document.getElementById('bCat').value;
        const year = document.getElementById('bYear').value;
        const stock = document.getElementById('bStock').value;
        const fileInput = document.getElementById('bImgFile');

        // Unified FormData for both Create and Update
        const formData = new FormData();
        formData.append("title", title);
        formData.append("author", author);
        formData.append("category", category);
        formData.append("published_year", year);
        formData.append("stock", stock);
        if (fileInput.files[0]) {
            formData.append("image", fileInput.files[0]);
        }

        if (id) {
            // Update (Multipart)
            await fetch(`/api/books/update?id=${id}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }, // No content-type for FormData
                body: formData
            });
        } else {
            // Create (Multipart)
            await fetch('/api/books/create', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });
        }

        toggleModal('bookModal', false);
        loadBooks();
    }

    async function delBook(id) {
        if (!confirm('Hapus buku?')) return;
        await fetch(`/api/books/delete?id=${id}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        loadBooks();
    }
</script>
{{end}}