<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMPUS Dashboard</title>
    <!-- Using Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --text-light: #ecf0f1;
            --text-dark: #2c3e50;
            --bg-light: #f4f6f9;
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background-color: var(--bg-light);
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            background-color: var(--secondary-color);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            flex-grow: 1;
        }

        .sidebar-menu li {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sidebar-menu a {
            padding: 15px 20px;
            display: block;
            color: var(--text-light);
            text-decoration: none;
            transition: background 0.3s;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: var(--accent-color);
        }

        .user-panel {
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
        }

        /* Main Content */
        .content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f1c40f;
            color: #333;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 500;
        }

        .search-bar {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            width: 400px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: white;
        }

        .bg-success {
            background-color: #2ecc71;
        }

        .bg-warning {
            background-color: #f1c40f;
        }

        .bg-danger {
            background-color: #e74c3c;
        }
    </style>
</head>

<body>
    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>SIMPUS v1.0</h3>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active" onclick="showSection('dashboard', this)">üìä Dashboard</a></li>

            <!-- ADMIN MENUS -->
            {{if eq .Role "admin"}}
            <li><a href="#" onclick="showSection('books', this)">üìö Manajemen Buku</a></li>
            <li><a href="#" onclick="showSection('members', this)">üë• Manajemen Anggota</a></li>
            <li><a href="#" onclick="showSection('transactions', this)">üîÑ Transaksi & Laporan</a></li>
            {{end}}

            <!-- MEMBER MENUS -->
            {{if ne .Role "admin"}}
            <li><a href="#" onclick="showSection('catalog', this)">üìñ Katalog Buku</a></li>
            <li><a href="#" onclick="showSection('my_loans', this)">üìÇ Peminjaman Saya</a></li>
            <li><a href="#" onclick="showSection('profile', this)">üë§ Profil Saya</a></li>
            {{end}}

            <li><a href="#" onclick="logout()">üö™ Logout</a></li>
        </ul>
        <div class="user-panel">
            <p>Logged in as: <strong>{{.Username}}</strong></p>
            <p>Role: {{.Role}}</p>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content">
        <!-- NOTIFICATIONS -->
        <div id="notification-area"
            style="display: none; background: #ffeaa7; padding: 10px; margin-bottom: 20px; border-radius: 4px; border-left: 5px solid #fdcb6e;">
            <strong>‚ö†Ô∏è Perhatian:</strong> <span id="notif-text"></span>
        </div>

        <!-- DASHBOARD SECTION -->
        <div id="dashboard" class="section active">
            <div class="header">
                <h2>Dashboard Overview</h2>
            </div>
            <div class="card">
                <h3>Selamat Datang di SIMPUS</h3>
                <p>Sistem Informasi Manajemen Perpustakaan Terpadu.</p>
                {{if eq .Role "admin"}}
                <p>Anda memiliki akses penuh untuk mengelola buku, anggota, dan transaksi.</p>
                {{else}}
                <p>Silakan cari buku di Katalog dan lakukan peminjaman.</p>
                {{end}}
            </div>
        </div>

        <!-- ======================= ADMIN SECTIONS ======================= -->
        {{if eq .Role "admin"}}

        <!-- MANAJEMEN BUKU -->
        <div id="books" class="section">
            <div class="header">
                <h2>Manajemen Buku</h2>
                <button class="btn btn-primary" onclick="openBookModal()">+ Tambah Buku</button>
            </div>
            <div class="card">
                <input type="text" class="search-bar" placeholder="üîç Cari judul, penulis, kategori..."
                    onkeyup="searchBooks(this.value)">
                <table id="adminBooksTable">
                    <thead>
                        <tr>
                            <th>Judul</th>
                            <th>Penulis</th>
                            <th>Kategori</th>
                            <th>Stok</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- MANAJEMEN ANGGOTA -->
        <div id="members" class="section">
            <div class="header">
                <h2>Manajemen Anggota</h2>
            </div>
            <div class="card">
                <input type="text" class="search-bar" placeholder="üîç Cari username atau nama..."
                    onkeyup="searchUsers(this.value)">
                <table id="adminUsersTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Nama Lengkap</th>
                            <th>Tipe</th>
                            <th>Role</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- TRANSAKSI -->
        <div id="transactions" class="section">
            <div class="header">
                <h2>Transaksi & Laporan</h2>
            </div>
            <div class="card">
                <h3>Daftar Peminjaman Aktif & Riwayat</h3>
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Peminjam</th>
                            <th>Buku</th>
                            <th>Tgl Pinjam</th>
                            <th>Jatuh Tempo</th>
                            <th>Status</th>
                            <th>Denda</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        {{end}}

        <!-- ======================= USER SECTIONS ======================= -->
        {{if ne .Role "admin"}}

        <!-- KATALOG BUKU -->
        <div id="catalog" class="section">
            <div class="header">
                <h2>Katalog Buku</h2>
            </div>
            <div class="card">
                <input type="text" class="search-bar" placeholder="üîç Cari buku yang ingin dipinjam..."
                    onkeyup="searchCatalog(this.value)">
                <div id="catalogGrid"
                    style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top:20px;">
                    <!-- Filled by JS -->
                </div>
            </div>
        </div>

        <!-- PEMINJAMAN SAYA -->
        <div id="my_loans" class="section">
            <div class="header">
                <h2>Peminjaman Saya</h2>
            </div>
            <div class="card">
                <table id="myLoansTable">
                    <thead>
                        <tr>
                            <th>Buku</th>
                            <th>Tgl Pinjam</th>
                            <th>Jatuh Tempo</th>
                            <th>Status</th>
                            <th>Denda</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- PRODILE SAYA -->
        <div id="profile" class="section">
            <div class="header">
                <h2>Profil Anggota</h2>
            </div>
            <div class="card">
                <p><strong>Username:</strong> {{.Username}}</p>
                <p><strong>Role:</strong> {{.Role}}</p>
                <p><em>Fitur edit profil akan segera hadir.</em></p>
            </div>
        </div>
        {{end}}
    </div>

    <!-- MODAL ADD BOOK -->
    <div id="bookModal" class="modal">
        <div class="modal-content">
            <h3>Tambah/Edit Buku</h3>
            <form id="bookForm" onsubmit="saveBook(event)">
                <div class="form-group"><label>Judul</label><input id="bTitle" required></div>
                <div class="form-group"><label>Penulis</label><input id="bAuthor" required></div>
                <div class="form-group"><label>Kategori</label><input id="bCat" required></div>
                <div class="form-group"><label>Stok</label><input type="number" id="bStock" required></div>
                <button type="submit" class="btn btn-primary">Simpan</button>
                <button type="button" class="btn btn-danger" onclick="closeModal('bookModal')">Batal</button>
            </form>
        </div>
    </div>

    <script>
        const role = "{{.Role}}";
        const token = getCookie('token');

        // Navigation Logic
        function showSection(id, element) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');

            document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            // Refresh data based on section
            if (id === 'books') loadAdminBooks();
            if (id === 'members') loadUsers();
            if (id === 'transactions') loadTransactions();
            if (id === 'catalog') loadCatalog();
            if (id === 'my_loans') loadMyLoans();
        }

        // --- AUTH ---
        function getCookie(name) {
            const v = `; ${document.cookie}`;
            const parts = v.split(`; ${name}=`);
            return parts.length === 2 ? parts.pop().split(';').shift() : null;
        }
        function logout() {
            document.cookie = 'token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/';
        }
        async function api(url, method = "GET", body = null) {
            const opts = { method, headers: { 'Authorization': `Bearer ${token}` } };
            if (body) {
                opts.headers['Content-Type'] = 'application/json';
                opts.body = JSON.stringify(body);
            }
            return fetch(url, opts).then(r => r.json());
        }

        // --- DATA LOADING ---

        // ADMIN: Books
        async function loadAdminBooks(q = '') {
            const books = await api(`/api/books?q=${q}`);
            const tbody = document.querySelector('#adminUsersTable tbody');
            // Populate table... logic similar to previous but refined
            const html = books && books.length ? books.map(b => `
                <tr>
                    <td>${b.title}</td><td>${b.author}</td><td>${b.category}</td><td>${b.stock}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteBook(${b.id})">Hapus</button></td>
                </tr>
            `).join('') : '<tr><td colspan="5">No books found</td></tr>';
            document.querySelector('#adminBooksTable tbody').innerHTML = html;
        }

        // ADMIN: Users
        async function loadUsers(q = '') {
            const users = await api(`/api/users?q=${q}`);
            const html = users && users.length ? users.map(u => `
                <tr>
                    <td>${u.username}</td><td>${u.fullname || '-'}</td><td>${u.member_type || '-'}</td><td>${u.role}</td>
                    <td>
                        ${u.role !== 'admin' ? `<button class="btn btn-danger btn-sm" onclick="alert('Delete not implemented via UI yet')">Hapus</button>` : ''}
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="5">No users found</td></tr>';
            document.querySelector('#adminUsersTable tbody').innerHTML = html;
        }

        // ADMIN: Transactions
        async function loadTransactions() {
            const loans = await api('/api/loans');
            const html = loans && loans.map(l => `
                <tr>
                    <td>${l.user ? l.user.username : '-'}</td>
                    <td>${l.book ? l.book.title : '-'}</td>
                    <td>${new Date(l.loan_date).toLocaleDateString()}</td>
                    <td>${new Date(l.due_date).toLocaleDateString()}</td>
                    <td><span class="badge ${l.status === 'returned' ? 'bg-success' : (l.status === 'borrowed' ? 'bg-warning' : 'bg-danger')}">${l.status}</span></td>
                    <td>${l.fine}</td>
                    <td>
                        ${l.status === 'borrowed' ? `<button class="btn btn-primary btn-sm" onclick="returnBook(${l.id})">Kembalikan</button>` : '-'}
                    </td>
                </tr>
            `).join('');
            document.querySelector('#transactionsTable tbody').innerHTML = html || '';
        }

        // USER: Catalog
        async function loadCatalog(q = '') {
            const books = await api(`/api/books?q=${q}`);
            const html = books && books.length ? books.map(b => `
                <div class="card" style="margin:0;">
                    <h4>${b.title}</h4>
                    <p>${b.author}</p>
                    <p>Stok: ${b.stock}</p>
                    ${b.stock > 0 ? `<button class="btn btn-primary" onclick="borrowBook(${b.id})">Pinjam</button>` : '<span class="badge bg-danger">Habis</span>'}
                </div>
            `).join('') : '<p>Buku tidak ditemukan.</p>';
            document.getElementById('catalogGrid').innerHTML = html;
        }

        // USER: My Loans
        async function loadMyLoans() {
            const loans = await api('/api/loans');
            const html = loans && loans.map(l => `
                <tr>
                    <td>${l.book ? l.book.title : '-'}</td>
                    <td>${new Date(l.loan_date).toLocaleDateString()}</td>
                    <td>${new Date(l.due_date).toLocaleDateString()}</td>
                    <td>${l.status}</td>
                    <td>${l.fine}</td>
                </tr>
            `).join('');
            document.querySelector('#myLoansTable tbody').innerHTML = html || '';

            // Notification Logic (Simple)
            const overdue = loans.filter(l => l.status === 'borrowed' && new Date(l.due_date) < new Date());
            if (overdue.length > 0) {
                document.getElementById('notification-area').style.display = 'block';
                document.getElementById('notif-text').innerText = `Anda memiliki ${overdue.length} buku yang terlambat dikembalikan!`;
            }
        }

        // ACTIONS
        async function borrowBook(id) {
            if (!confirm("Pinjam buku ini?")) return;
            const res = await fetch('/api/loans', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ book_id: id }) });
            if (res.ok) { alert('Berhasil dipinjam'); loadCatalog(); }
            else alert('Gagal meminjam');
        }

        async function returnBook(id) {
            const res = await fetch('/api/loans/return', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ loan_id: id }) });
            if (res.ok) { alert('Berhasil dikembalikan'); loadTransactions(); }
        }

        function searchBooks(val) { loadAdminBooks(val); }
        function searchUsers(val) { loadUsers(val); }
        function searchCatalog(val) { loadCatalog(val); }

        // MODALS
        function openBookModal() { document.getElementById('bookModal').style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function saveBook(e) {
            e.preventDefault();
            const data = {
                title: document.getElementById('bTitle').value,
                author: document.getElementById('bAuthor').value,
                category: document.getElementById('bCat').value,
                stock: parseInt(document.getElementById('bStock').value)
            };
            const res = await fetch('/api/books/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                alert('Buku tersimpan');
                closeModal('bookModal');
                loadAdminBooks();
            }
        }

        // INITIAL LOAD
        if (role === 'admin') {
            loadAdminBooks();
        } else {
            loadCatalog();
            loadMyLoans(); // Run this to check for notifications
        }

    </script>
</body>

</html>